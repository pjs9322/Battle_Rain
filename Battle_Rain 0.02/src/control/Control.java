package control;

import java.io.Serializable;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.Vector;

import main.constant;
import main.constant.STATE;
import model.Audio;
import model.Database;

import com.mongodb.BasicDBObject;
import com.mongodb.DBCursor;
import com.mongodb.DBObject;

public class Control {
	private Database db;
	private DBObject userData;
	public DBObject getUserData() { return userData; }
	public void setChara(int chara) { this.userData.put("icon", chara); }

	private DBObject roomData;
	public String getRoomIP() { return (String) this.roomData.get("hostIP"); }

	private boolean roomState; // false 가 클라이언트
	public boolean getRoomState() {return roomState;}

	private Vector<RWord> wordList = new Vector<RWord>();
	public Vector<RWord> getWordList() { return wordList; }
	public void setWordList(Vector<RWord> wordList) { this.wordList = wordList; }

	private STATE nextState = STATE.Login;
	public STATE getNextState() { return nextState; }

	public Control() {
		this.userData = null;
		this.roomData = null;
		this.roomState = false;

		this.db = new Database();
		this.db.connect();
	}

	public String user_Login(String userID, String password) {
		String alart = null;
		if (userID.equals("") || password.equals("")) {
			alart = "ID와 비밀번호를 입력해주세요.";
			return alart;
		}
		//입력받은 ID로 DB에 있는 Object(column)를 받아온다.
		DBObject userData = db.find("User", "id", userID);
		//회원가입된 유저가 존재하고 비밀번호가 일치하면 대기실로 진입한다.
		if (userData != null && userData.get("password").equals(password)) {
			this.userData = userData;
			this.nextState = STATE.Wait;
		} else {
			alart = "계정 정보가 일치하지 않습니다.";
		}
		return alart;
	}

	public void user_Logout() {
		if (this.nextState.equals(STATE.Wait)) {
			this.userData = null;
			this.nextState = STATE.Login;
		}
	}

	public String user_Join(String userID, String password, String name) {
		String alart = null;
		if (userID.equals("") || password.equals("") || name.equals("")) {
			alart = "항목을 전부 입력해주세요.";
			return alart;
		}
		if (userID.contains(" ") || password.contains(" ") || name.contains(" ")) {
			alart = "공백이 포함될 수 없습니다.";
			return alart;
		}
		//입력받은 ID가 DB에 존재하지 않으면 계정을 DB에 저장한다.
		DBObject userData1 = db.find("User", "id", userID);
		DBObject userData2 = db.find("User", "name", name);
		if (userData1 == null) {
			if (userData2 == null) {
				BasicDBObject tempBasicDBObj = new BasicDBObject("id", userID)
				.append("password", password)
				.append("name", name)
				.append("icon", 0);      //캐릭터 아이콘 [0,7] default 0
				db.insert("User",  tempBasicDBObj);
			} else {
				alart = "중복된 닉네임니다.";
			}
		} else {
			alart = "ID가 중복됩니다.";
		}
		return alart;
	}

	public Vector<DBObject> readRoomList() {
		DBCursor cursor = db.find("Room");
		Vector<DBObject> temp = new Vector<DBObject>();
		for (int i = 0; cursor.hasNext() && i < 4; i++) {
			temp.add(cursor.next());
		}
		return temp;
	}

	public String Room_Make(String roomName, boolean mode) {
		String alart = null;
		if (this.nextState.equals(constant.STATE.Wait)) {
			if (roomName.replaceAll(" ", "").equals("")) {
				alart = "방 제목을 입력해주세요.";
				return alart;
			}
			DBObject roomData = db.find("Room", "master", (String) this.userData.get("name"));
			// 이미 자기가 만든 방이 있으면 DB에서 해당 방을 삭제

			//입력받은 방제목이 DB에 존재하지 않는다면 방 정보를 DB에 추가하고 그 방으로 진입한다.
			roomData = db.find("Room", "rname", roomName);
			if (roomData == null) {
				BasicDBObject tempBasicDBObj = null;
				try {
					tempBasicDBObj = new BasicDBObject("rname", roomName)
					.append("master", this.userData.get("name"))
					.append("mode", mode)   //게임 모드 [0,1] default 0
					.append("state", 0)
					.append("ucount", 1)
					.append("hostIP", InetAddress.getLocalHost().getHostAddress());
				} catch (UnknownHostException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				db.insert("Room",  tempBasicDBObj);
				this.roomState = true;
				this.nextState = STATE.Room;
			} else {
				alart = "중복된 방 제목입니다.";
			}
		}
		return alart;
	}

	public String Room_Search(String roomName) {
		String alart = null;
		if (this.nextState.equals(constant.STATE.Wait)) {
			if (roomName.replaceAll(" ", "").equals("")) {
				alart = "방 제목을 입력해주세요.";
				return alart;
			}
			//입력받은 방제목이 존재하면 그 방으로 진입한다.
			DBObject roomData = db.find("Room", "rname", roomName);
			if (roomData != null) {
				this.nextState = STATE.Room;
				this.roomData = roomData;
			} else {
				alart = "존재하지 앖는 방입니다.";
			}
		}
		return alart;
	}

	public void room_exit() {
		if (this.nextState.equals(STATE.Room)) {
			this.nextState = STATE.Wait;
		}
	}
	
	public void word_Make() {
		DBCursor cursor = db.find("Word");
		String[] temp = new String[5887];
		for (int i = 0; cursor.hasNext(); i++) {
			temp[i] = (String) cursor.next().get("word");
		}
		
		for (int i = 0; i < 2000; i++) {
			wordList.add(new RWord(temp[(int) (Math.random()*5887)], i));
		}
	}
	
	public boolean removeWord(String text) {
		for (RWord word: wordList) {
			if (word.word.equals(text) && word.Y > 0 && word.Y < 473) {
				if (!constant.delay) {
					new Audio(constant.M_Route[5], false);
					constant.delay = true;
				}
				wordList.remove(word);
				return true;
			}
		}
		return false;
	}
	
	public class RWord implements Serializable {
		private static final long serialVersionUID = 1L;
		
		public String word;
		public boolean effect;
		public int X;
		public int Y;
		
		public RWord (String word, int i) {
			this.word = word;
			this.effect = Math.random() < 0.05;
			this.X = (int) (Math.random()*420);
			this.Y = -12 * i;
		}
	}
}
