package control;

import java.io.IOException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.Vector;

import javax.swing.JPanel;

import main.constant.STATE;
import model.Database;
import model.Room_Model;

import com.mongodb.BasicDBObject;
import com.mongodb.DBObject;

public class Control {
	private Database db;
	private DBObject userData;

	private Room_Model room;
	
	private boolean roomState = false; // false 가 클라이언트
	public boolean getRoomState() {return roomState;}
	
	private Vector<RWord> wordList = new Vector<RWord>();
	public Vector<RWord> getWordList() { return wordList; }
	
	private STATE next_State = STATE.Login;
	public STATE getNext_State() { return next_State; }
	
	
	public Control() {
		this.db = new Database();
		this.userData = null;
		this.room = new Room_Model();
	}
	
	public String user_Login(String userID, String password) {
		String alart = null;
		//입력받은 ID로 DB에 있는 Object(column)를 받아온다.
		DBObject userData = db.find("User", "id", userID);
		//회원가입된 유저가 존재하고 비밀번호가 일치하면 대기실로 진입한다.
		if (userData != null && userData.get("password").equals(password)) {
			this.userData = userData;
			this.next_State = STATE.Wait;
		}
		return alart;
	}
	
	public void user_Logout() {
		if (this.next_State.equals(STATE.Wait)) {
			this.userData = null;
			this.next_State = STATE.Login;
		}
	}
	
	public String user_Join(String userID, String password, String name) {
		String alart = null;
		//입력받은 ID가 DB에 존재하지 않으면 계정을 DB에 저장한다.
		DBObject userData = db.find("User", "id", userID);
		if (userData == null) {
			BasicDBObject tempBasicDBObj = new BasicDBObject("id", userID)
					.append("password", password)
					.append("name", name)
					.append("icon", 0);		//캐릭터 아이콘 [0,7] default 0
			db.insert("User",  tempBasicDBObj);
		}
		return alart;
	}

	public String Room_Make(String roomName) {
		String alart = null;
		//입력받은 방제목이 DB에 존재하지 않는다면 방 정보를 DB에 추가하고 그 방으로 진입한다.
		DBObject roomData = db.find("Room", "rname", roomName);
		if (roomData == null) {
			BasicDBObject tempBasicDBObj = null;
			try {
				tempBasicDBObj = new BasicDBObject("rname", roomName)
						.append("master", this.userData.get("name"))
						.append("mode", 0)	//게임 모드 [0,1] default 0
						.append("hostIP", InetAddress.getLocalHost().getHostAddress());
			} catch (UnknownHostException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			db.insert("Room",  tempBasicDBObj);
			this.next_State = STATE.Room;
		}
		return alart;
	}

	public void room_exit() {
		if (this.next_State.equals(STATE.Room)) {
			this.next_State = STATE.Wait;
		}
	}

	
	public String Room_Search(String roomName) {
		String alart = null;
		//입력받은 방제목이 존재하면 그 방으로 진입한다.
		DBObject roomData = db.find("Room", "rname", roomName);
		if (roomData != null) {
			this.next_State = STATE.Room;
		}
		return alart;
	}
	
	public void word_Make() {
		String[] temp = new String[5887];
		for (int i = 0; db.find("word").hasNext(); i++) {
			db.find("word").next();
		}
		
		for (int i = 0; i < 10; i++) {
			wordList.add(new RWord("단어"));
		}
	}
	
	
	public void insert_Word(JPanel rainFeild, String text) {
		for (RWord word: wordList) {
			if (word.word.equals(text) && word.Y > 0 && word.Y < 473) {
				wordList.remove(word);
				return;
			}
		}
	}
	
	public class RWord {
		public String word;
		public int X;
		public int Y;
		
		public RWord (String word) {
			this.word = word;
			this.X = (int) (Math.random()*520);
			this.Y = (int) -(Math.random()*600);
		}
	}
}
